{% extends 'team8/base.html' %}

{% block title %}Word Details{% endblock %}

{% block extra_css %}
<style>
    /* Specific styles for Word Card */
    :root { --bg-gradient: linear-gradient(180deg, #f8d7da 0%, #d1e7dd 100%); }
    .container { max-width: 850px; margin: 30px auto; padding: 0 20px; }
    
    .ai-header { background: rgba(255, 255, 255, 0.7); padding: 15px 20px; border-radius: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .icon-star { background: #ff9e67; color: white; padding: 5px; border-radius: 8px; font-size: 12px; }
    .card { background: white; border-radius: 24px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: left; direction: ltr; }
    .word-title-row { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
    .word-title-row h1 { font-size: 40px; margin: 0; text-transform: lowercase; }
    .level-badge { border: 2px solid #ffca28; color: #f9a825; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }
    .phonetic { color: #636e72; font-size: 18px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
    .phonetic button { border: none; background: none; cursor: pointer; font-size: 20px; color: #42a5f5; }
    .definition { color: #30336b; font-size: 18px; line-height: 1.6; margin-bottom: 35px; }
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
    .section-label { font-size: 13px; color: #b2bec3; font-weight: bold; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 500; }
    .tag-syn { background: #e3f2fd; color: #1976d2; }
    .tag-ant { background: #ffebee; color: #d32f2f; }
    .tag-coll { border: 1.5px solid #90caf9; color: #1565c0; }
    .example-item { background: #f8fafc; border: 1px solid #edf2f7; padding: 15px 20px; border-radius: 12px; margin-bottom: 12px; font-style: italic; color: #4a5568; font-size: 15px; }
    .btn-next { width: 100%; background: linear-gradient(90deg, #ff8a65, #ffb199); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; font-family: 'Vazirmatn'; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-next:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 138, 101, 0.3); }
    .btn-next:disabled { opacity: 0.7; cursor: wait; }
    .btn-mnemonic {width: 100%;background: linear-gradient(90deg, #6c5ce7, #a29bfe);color: white;border: none;padding: 18px;border-radius: 15px;font-size: 18px;font-weight: bold;cursor: pointer;margin-top: 15px;font-family: 'Vazirmatn';transition: 0.3s;display: flex;justify-content: center;align-items: center;gap: 10px;}
    .btn-mnemonic:hover {transform: translateY(-2px);box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);}
    .btn-mnemonic:disabled {opacity: 0.5;cursor: not-allowed;transform: none;box-shadow: none;}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="ai-header">
        <div class="icon-star">âœ¦</div>
        <div style="direction: ltr; text-align: left;">
            <strong style="font-size: 14px; display: block;">AI-Generated Study</strong>
            <span style="font-size: 12px; color: #636e72;">Words tailored to your learning level</span>
        </div>
    </div>

    <div class="card" id="wordCard">
        <div class="word-title-row">
            <h1 id="word-text">Loading...</h1>
            <span id="word-level" class="level-badge">--</span>
        </div>
        <div class="phonetic">
            <button id="playAudioBtn" onclick="playPronunciation()" disabled>ðŸ”Š</button>
            <span id="word-phonetic"></span>
        </div>
        <audio id="wordAudio" style="display:none"></audio>
        <div class="definition" id="word-definition">Generating your next personalized word...</div>
        <div class="details-grid">
            <div><div class="section-label">Synonyms</div><div class="tag-list" id="word-synonyms"></div></div>
            <div><div class="section-label">Antonyms</div><div class="tag-list" id="word-antonyms"></div></div>
        </div>
        <div class="section-label">Collocations</div>
        <div class="tag-list" style="margin-bottom: 30px;" id="word-collocations"></div>
        <div class="section-label">Example Sentences</div>
        <div id="word-examples"></div>
    </div>

    <button class="btn-next" id="nextBtn" onclick="generateNewWord()">Generate âœ¨</button>
    <button class="btn-mnemonic" id="mnemonicBtn" onclick="goToMnemonic()">ðŸ§  Visual Mnemonic</button>

</div>
{% endblock %}

{% block scripts %}
<script>
    function goToMnemonic() {
        const wordElement = document.getElementById('word-text');
        if (!wordElement) return;
        
        let word = wordElement.textContent.trim();
        if (word === 'Loading...' || word === '') {
            alert('Please generate a word first.');
            return;
        }
        window.location.href = `/team8/mnemonics/?word=${encodeURIComponent(word)}`;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function renderWord(data) {
        document.getElementById('word-text').textContent = data.word;
        document.getElementById('word-level').textContent = data.level || 'B2';
        document.getElementById('word-phonetic').textContent = data.ipa || '';
        document.getElementById('word-definition').textContent = data.definition || '';

        const synContainer = document.getElementById('word-synonyms');
        const synonyms = Array.isArray(data.synonyms) ? data.synonyms : [];
        synContainer.innerHTML = synonyms.map(s => `<span class="tag tag-syn">${s}</span>`).join('');

        const antContainer = document.getElementById('word-antonyms');
        const antonyms = Array.isArray(data.antonyms) ? data.antonyms : [];
        antContainer.innerHTML = antonyms.map(a => `<span class="tag tag-ant">${a}</span>`).join('');

        const colContainer = document.getElementById('word-collocations');
        const collocations = Array.isArray(data.collocations) ? data.collocations : [];
        colContainer.innerHTML = collocations.map(c => `<span class="tag tag-coll">${c}</span>`).join('');

        const exContainer = document.getElementById('word-examples');
        const examples = Array.isArray(data.examples) ? data.examples : [];
        exContainer.innerHTML = examples.map(ex => `<div class="example-item">${ex}</div>`).join('');

        const word = data.word;
        const audioElement = document.getElementById('wordAudio');
        const playBtn = document.getElementById('playAudioBtn');
        playBtn.disabled = true;
        playBtn.textContent = "â³";
        
        fetch(`/team8/api/tts/?text=${encodeURIComponent(word)}&lang=en`)
            .then(response => response.json())
            .then(data => {
                if (data.audio_url) {
                    audioElement.src = data.audio_url;
                    playBtn.disabled = false;
                    playBtn.textContent = "ðŸ”Š";
                }
            })
            .catch(error => {
                playBtn.disabled = false;
                playBtn.textContent = "ðŸ”‡";
            });

        document.getElementById('mnemonicBtn').disabled = false;
    }

    function playPronunciation() {
        const audio = document.getElementById('wordAudio');
        if (audio.src) audio.play();
    }

    // --- FIX: This function now optionally accepts a specific word ---
    async function generateNewWord(targetWord = null) {
        const btn = document.getElementById('nextBtn');
        btn.disabled = true;
        btn.textContent = "AI is thinking...";

        try {
            const response = await fetch('/team8/wordcard/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                // Pass the word in the body if it's provided
                body: targetWord ? `word=${encodeURIComponent(targetWord)}` : ''
            });

            const result = await response.json();
            if (result.status === "success") {
                renderWord(result.data);
                // --- Cleanup URL after loading a specific word ---
                if (targetWord) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } else {
                alert("Error from AI: " + (result.error || "Unknown error"));
            }
        } catch (error) {
            console.error("Error:", error);
        } finally {
            btn.disabled = false;
            btn.textContent = "Generate âœ¨";
        }
    }

    // --- FIX: Check for 'word' parameter in the URL on load ---
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const wordParam = urlParams.get('word');

        if (wordParam) {
            generateNewWord(wordParam);
        } else {
            generateNewWord();
        }
    };
</script>
{% endblock %}