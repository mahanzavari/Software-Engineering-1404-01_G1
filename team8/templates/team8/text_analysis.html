<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabAI | Text Analysis</title>
    
    <!-- Vazirmatn Font (Required by Project) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            --primary-orange: #ff8a65;
            --secondary-orange: #ffb199;
            --bg-gradient: linear-gradient(180deg, #fce4ec 0%, #e3f2fd 100%);
            --text-dark: #2d3436;
            --text-grey: #636e72;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* --- Navigation --- */
        nav {
            background: white;
            padding: 10px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .logo { font-weight: bold; text-decoration: none; color: var(--text-dark); font-size: 20px; }
        .nav-tabs { display: flex; gap: 15px; list-style: none; margin: 0; padding: 0; }
        .nav-tabs li { padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; color: var(--text-grey); }
        .nav-tabs li.active { background: #ff7043; color: white; font-weight: bold; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }

        /* --- Page Header --- */
        .header-card {
            background: white;
            border-radius: 20px;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        .icon-box { background: #ffe0d1; color: #ff8a65; padding: 10px; border-radius: 12px; font-size: 20px; }

        /* --- Selection View --- */
        .card-ui {
            background: white;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .btn-main {
            background: linear-gradient(90deg, var(--primary-orange), var(--secondary-orange));
            color: white;
            border: none;
            padding: 15px 45px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Vazirmatn';
            transition: 0.3s;
            margin: 20px 0;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 138, 101, 0.3); }
        .btn-main:disabled { opacity: 0.6; cursor: wait; }

        /* Manual Selection List */
        .history-list {
            max-height: 350px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #eee;
            border-radius: 15px;
            text-align: left;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f9f9f9;
            transition: 0.2s;
        }
        .history-item:hover { background: #fcfcfc; }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; display: block; margin-bottom: 4px; }
        .item-meta { font-size: 12px; color: #999; }

        /* --- Results View --- */
        #results-view { display: none; }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .level-card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: 1px solid #f1f1f1;
            animation: slideUp 0.5s ease;
        }
        .level-badge {
            background: #2d3436;
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 20px;
        }
        .preview-tags {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .tag {
            background: #f1f2f6;
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 13px;
            color: #555;
        }
        .btn-study {
            width: 100%;
            background: #2d3436;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Vazirmatn';
            transition: 0.2s;
        }
        .btn-study:hover { background: #000; }

        /* Loading Animation */
        #loading-overlay {
            display: none;
            text-align: center;
            padding: 60px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <nav>
        <a href="/team8/" class="logo">‚ú¶ VocabAI</a>
        <ul class="nav-tabs">
            <li>Word Cards</li>
            <li>Practice</li>
            <li>Mnemonics</li>
            <li class="active">Text Analysis</li>
            <li>Analytics</li>
        </ul>
    </nav>

    <div class="container">
        
        <!-- HEADER -->
        <div class="header-card">
            <div class="icon-box">üìÑ</div>
            <div style="text-align: left;">
                <strong style="display: block; font-size: 18px;">Text Analysis</strong>
                <span style="font-size: 13px; color: var(--text-grey);">Extract difficult words from your reading history</span>
            </div>
        </div>

        <!-- 1. VIEW: SELECTION -->
        <div id="selection-view">
            <!-- Quick Analysis Card -->
            <div class="card-ui">
                <div style="font-size: 50px; margin-bottom: 15px;">‚ö°</div>
                <h2 style="margin:0">Quick Analysis</h2>
                <p style="color: var(--text-grey); margin-top: 10px;">Automatically analyze your 5 most recent readings.</p>
                <button class="btn-main" onclick="startAIAnalysis('quick')">Start Quick Analysis</button>
                <div style="font-size: 12px; color: #b2bec3; display: flex; justify-content: center; gap: 20px;">
                    <span>üìñ 5 Recent Texts</span>
                    <span>‚ú® AI-Powered</span>
                </div>
            </div>

            <!-- Manual Selection Card -->
            <div class="card-ui" style="text-align: left;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="background: #fff9db; padding: 10px; border-radius: 12px;">üìù</div>
                    <strong>Manual Selection</strong>
                </div>
                <p style="font-size: 14px; color: var(--text-grey); margin-bottom: 20px;">Select specific readings to analyze vocabulary.</p>
                
                <div class="history-list" id="historyList">
                    <!-- History items will be loaded here via JS -->
                    <div style="padding: 20px; text-align: center; color: #ccc;">Loading your history...</div>
                </div>

                <button class="btn-main" style="width: 100%;" id="manualBtn" onclick="startAIAnalysis('manual')">
                    Analyze Selected Readings
                </button>
            </div>
        </div>

        <!-- 2. VIEW: LOADING -->
        <div id="loading-overlay">
            <div class="spinner"></div>
            <h2 id="loading-text">AI is analyzing your content...</h2>
            <p style="color: var(--text-grey);">Categorizing new vocabulary by difficulty level.</p>
        </div>

        <!-- 3. VIEW: RESULTS -->
        <div id="results-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #30336b;">Extracted Vocabulary</h2>
                <button onclick="location.reload()" style="background:none; border:none; color:#6c5ce7; cursor:pointer; font-family:'Vazirmatn'; font-weight:bold;">
                    ‚Üê Reset Analysis
                </button>
            </div>
            
            <!-- Cards (A1-C2) will be injected here -->
            <div class="results-grid" id="resultsGrid"></div>
        </div>

    </div>

    <script>
        // 1. Load history when page opens
        window.onload = async function() {
            try {
                const response = await fetch('/team8/api/reading-history/');
                const data = await response.json();
                const historyList = document.getElementById('historyList');

                if (data.history && data.history.length > 0) {
                    historyList.innerHTML = data.history.map(item => `
                        <div class="history-item">
                            <input type="checkbox" value="${item.id}" class="reading-checkbox">
                            <div class="item-info">
                                <span class="item-title">${item.title}</span>
                                <span class="item-meta">${item.category} ‚Ä¢ ${item.date || 'Recent'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">No reading history found.</div>';
                    document.getElementById('manualBtn').disabled = true;
                }
            } catch (error) {
                console.error("History Load Error:", error);
            }
        };

        // 2. Main Analysis Trigger
        async function startAIAnalysis(mode) {
            const selectionView = document.getElementById('selection-view');
            const loadingOverlay = document.getElementById('loading-overlay');
            const resultsView = document.getElementById('results-view');
            const resultsGrid = document.getElementById('resultsGrid');

            let url = `/team8/api/text-analysis/?mode=${mode}`;

            // If manual, gather selected IDs
            if (mode === 'manual') {
                const selected = Array.from(document.querySelectorAll('.reading-checkbox:checked')).map(cb => cb.value);
                if (selected.length === 0) {
                    alert("Please select at least one reading.");
                    return;
                }
                selected.forEach(id => url += `&ids[]=${id}`);
            }

            // UI Switch to Loading
            selectionView.style.display = 'none';
            loadingOverlay.style.display = 'block';

            try {
                const response = await fetch(url);
                const data = await response.json();

                // 3. Render Level Cards dynamically
                resultsGrid.innerHTML = ''; // Clear previous
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'level-card';
                        card.innerHTML = `
                            <div class="level-badge">${item.level}</div>
                            <h3 style="margin-bottom: 5px;">${item.count} words found</h3>
                            <p style="font-size:13px; color:#999; margin-top:0;">Suggested for your level</p>
                            <div class="preview-tags">
                                ${item.preview.map(word => `<span class="tag">${word}</span>`).join('')}
                            </div>
                            <button class="btn-study" onclick="goToStudy('${item.level}')">Study Level ${item.level}</button>
                        `;
                        resultsGrid.appendChild(card);
                    });

                    loadingOverlay.style.display = 'none';
                    resultsView.style.display = 'block';
                } else {
                    document.getElementById('loading-text').innerText = "No significant vocabulary found.";
                }

            } catch (error) {
                alert("AI Analysis failed. Check backend connection.");
                selectionView.style.display = 'block';
                loadingOverlay.style.display = 'none';
            }
        }

        function goToStudy(level) {
            // Redirect to Word Card page with the selected level
            window.location.href = `/team8/wordcard/?level=${level}`;
        }
    </script>
</body>
</html>